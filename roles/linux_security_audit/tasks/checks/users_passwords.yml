---
- name: USERS | Count accounts with empty password field
  ansible.builtin.shell: |
    set -o pipefail
    awk -F: '($2 == "") {print $1}' /etc/shadow 2>/dev/null | wc -l
  args:
    executable: /bin/bash
  register: shadow_empty_pw_count
  changed_when: false
  failed_when: false

- name: USERS | Evaluate empty password field
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results + [check_result] }}"
    audit_score: "{{ audit_score | int + (1 if check_result.status == 'OK' else 0) }}"
    total_checks: "{{ total_checks | int + 1 }}"
  vars:
    empty_pw: "{{ shadow_empty_pw_count.stdout | int }}"
    check_result:
      id: "ANSSI-LIN-AUTH-01"
      category: "AUTH"
      name: "No local accounts with empty password field"
      severity: "HIGH"
      status: "{{ 'OK' if empty_pw == 0 else 'FAIL' }}"
      detail: "{{ empty_pw }} account(s) have an empty password field in /etc/shadow"
      evidence: "Empty password count: {{ empty_pw }}"
      remediation: "Lock or set passwords for any account with an empty password field (usermod -L <user> or passwd <user>)"

- name: AUTH | Read PASS_MAX_DAYS from /etc/login.defs
  ansible.builtin.shell: |
    set -o pipefail
    awk '$1=="PASS_MAX_DAYS"{print $2}' /etc/login.defs | head -n1
  args:
    executable: /bin/bash
  register: pass_max_days
  changed_when: false
  failed_when: false

- name: AUTH | Evaluate password aging policy
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results + [check_result] }}"
    audit_score: "{{ audit_score | int + (1 if check_result.status == 'OK' else 0) }}"
    total_checks: "{{ total_checks | int + 1 }}"
  vars:
    cfg_val: "{{ (pass_max_days.stdout | trim) }}"
    cfg_int: "{{ (cfg_val | int) if (cfg_val | length) > 0 else -1 }}"
    threshold: "{{ max_password_age_days | int }}"
    check_result:
      id: "ANSSI-LIN-AUTH-02"
      category: "AUTH"
      name: "Password maximum age configured"
      severity: "MEDIUM"
      status: "{{ 'OK' if (cfg_int > 0 and cfg_int <= threshold) else 'WARN' }}"
      detail: >-
        PASS_MAX_DAYS={{ cfg_val if (cfg_val | length) > 0 else 'not set' }}
        (expected <= {{ threshold }})
      evidence: "/etc/login.defs: PASS_MAX_DAYS {{ cfg_val if (cfg_val | length) > 0 else '<not set>' }}"
      remediation: "Set PASS_MAX_DAYS to an appropriate value (e.g., {{ threshold }}) in /etc/login.defs and ensure user policies align"

- name: PRIV | Check sudo presence
  ansible.builtin.command: sudo -V
  register: sudo_version
  changed_when: false
  failed_when: false

- name: PRIV | Check admin group (sudo or wheel)
  ansible.builtin.shell: |
    getent group sudo >/dev/null 2>&1 && echo sudo && exit 0
    getent group wheel >/dev/null 2>&1 && echo wheel && exit 0
    echo none
  args:
    executable: /bin/bash
  register: admin_group
  changed_when: false
  failed_when: false

- name: PRIV | Evaluate sudo configuration
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results + [check_result] }}"
    audit_score: "{{ audit_score | int + (1 if check_result.status == 'OK' else 0) }}"
    total_checks: "{{ total_checks | int + 1 }}"
  vars:
    sudo_ok: "{{ sudo_version.rc == 0 }}"
    grp: "{{ admin_group.stdout | trim }}"
    grp_ok: "{{ grp in ['sudo', 'wheel'] }}"
    check_result:
      id: "ANSSI-LIN-PRIV-01"
      category: "PRIVILEGES"
      name: "Privilege escalation via sudo is available"
      severity: "LOW"
      status: "{{ 'OK' if (sudo_ok and grp_ok) else 'WARN' }}"
      detail: >-
        sudo={{ 'present' if sudo_ok else 'missing' }}, admin_group={{ grp }}
      evidence: "sudo -V rc={{ sudo_version.rc }}, admin_group={{ grp }}"
      remediation: "Install sudo and manage admin access via a dedicated group (sudo/wheel) with least privilege"

- name: AUTH | Check root account password status
  ansible.builtin.command: passwd -S root
  register: root_passwd_status
  changed_when: false
  failed_when: false

- name: AUTH | Evaluate root account status
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results + [check_result] }}"
    audit_score: "{{ audit_score | int + (1 if check_result.status == 'OK' else 0) }}"
    total_checks: "{{ total_checks | int + 1 }}"
  vars:
    root_state: "{{ (root_passwd_status.stdout.split()[1] | default('UNKNOWN')) }}"
    root_locked: "{{ root_state == 'L' }}"
    check_result:
      id: "ANSSI-LIN-AUTH-03"
      category: "AUTH"
      name: "Root account locked (password)"
      severity: "MEDIUM"
      status: "{{ 'OK' if root_locked else 'INFO' }}"
      detail: "{{ 'Locked' if root_locked else ('Status=' ~ root_state) }}"
      evidence: "{{ root_passwd_status.stdout | default('') }}"
      remediation: "If policy requires, lock root password (passwd -l root) and rely on sudo; ensure SSH root login is disabled"
