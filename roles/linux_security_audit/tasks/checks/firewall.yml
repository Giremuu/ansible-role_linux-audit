---
- name: FW | Check UFW status (if present)
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  failed_when: false

- name: FW | Evaluate UFW active
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results + [check_result] }}"
    audit_score: "{{ audit_score | int + (1 if check_result.status == 'OK' else 0) }}"
    total_checks: "{{ total_checks | int + 1 }}"
  vars:
    ufw_active: "{{ (ufw_status.rc == 0) and ('Status: active' in (ufw_status.stdout | default(''))) }}"
    check_result:
      id: "ANSSI-LIN-FW-01"
      category: "FIREWALL"
      name: "Host firewall enabled (UFW)"
      severity: "HIGH"
      status: "{{ 'OK' if ufw_active else 'INFO' }}"
      detail: "{{ 'UFW is active' if ufw_active else 'UFW not active or not installed' }}"
      evidence: "{{ 'ufw status rc=' ~ ufw_status.rc ~ ' first_line=' ~ ((ufw_status.stdout_lines | default([]) | first) | default('')) }}"
      remediation: "Enable a host firewall (UFW, nftables, or firewalld) and ensure a default deny policy for inbound traffic"

- name: FW | Check firewalld status (systemd)
  ansible.builtin.command: systemctl is-active firewalld
  register: firewalld_active
  changed_when: false
  failed_when: false

- name: FW | Evaluate firewalld active
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results + [check_result] }}"
    audit_score: "{{ audit_score | int + (1 if check_result.status == 'OK' else 0) }}"
    total_checks: "{{ total_checks | int + 1 }}"
  vars:
    fwld_ok: "{{ firewalld_active.rc == 0 and (firewalld_active.stdout | trim) == 'active' }}"
    check_result:
      id: "ANSSI-LIN-FW-02"
      category: "FIREWALL"
      name: "Host firewall enabled (firewalld)"
      severity: "HIGH"
      status: "{{ 'OK' if fwld_ok else 'INFO' }}"
      detail: "{{ 'firewalld is active' if fwld_ok else 'firewalld is not active or not installed' }}"
      evidence: "{{ 'systemctl is-active firewalld => ' ~ (firewalld_active.stdout | default('')) ~ ' (rc=' ~ firewalld_active.rc ~ ')' }}"
      remediation: "Enable a host firewall (UFW, nftables, or firewalld) and ensure a default deny policy for inbound traffic"

- name: FW | Check nftables service status (systemd)
  ansible.builtin.command: systemctl is-active nftables
  register: nftables_active
  changed_when: false
  failed_when: false

- name: FW | Evaluate nftables active
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results + [check_result] }}"
    audit_score: "{{ audit_score | int + (1 if check_result.status == 'OK' else 0) }}"
    total_checks: "{{ total_checks | int + 1 }}"
  vars:
    nft_ok: "{{ nftables_active.rc == 0 and (nftables_active.stdout | trim) == 'active' }}"
    check_result:
      id: "ANSSI-LIN-FW-03"
      category: "FIREWALL"
      name: "Host firewall enabled (nftables)"
      severity: "HIGH"
      status: "{{ 'OK' if nft_ok else 'INFO' }}"
      detail: "{{ 'nftables service is active' if nft_ok else 'nftables service is not active or not installed' }}"
      evidence: "{{ 'systemctl is-active nftables => ' ~ (nftables_active.stdout | default('')) ~ ' (rc=' ~ nftables_active.rc ~ ')' }}"
      remediation: "Enable a host firewall (UFW, nftables, or firewalld) and ensure a default deny policy for inbound traffic"

- name: FW | Determine if any host firewall is enabled
  ansible.builtin.set_fact:
    host_firewall_enabled: >-
      {{
        (
          ((ufw_status.rc == 0) and ('Status: active' in (ufw_status.stdout | default(''))))
          or ((firewalld_active.rc == 0) and ((firewalld_active.stdout | trim) == 'active'))
          or ((nftables_active.rc == 0) and ((nftables_active.stdout | trim) == 'active'))
        )
      }}

- name: FW | Final evaluation (at least one firewall active)
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results + [check_result] }}"
    audit_score: "{{ audit_score | int + (1 if check_result.status == 'OK' else 0) }}"
    total_checks: "{{ total_checks | int + 1 }}"
  vars:
    check_result:
      id: "ANSSI-LIN-FW-00"
      category: "FIREWALL"
      name: "Host firewall enabled (overall)"
      severity: "HIGH"
      status: "{{ 'OK' if host_firewall_enabled else 'FAIL' }}"
      detail: "{{ 'At least one firewall backend is active' if host_firewall_enabled else 'No firewall backend detected as active (UFW/firewalld/nftables)' }}"
      evidence: >-
        ufw_active={{ ((ufw_status.rc == 0) and ('Status: active' in (ufw_status.stdout | default('')))) | string }},
        firewalld_active={{ ((firewalld_active.rc == 0) and ((firewalld_active.stdout | trim) == 'active')) | string }},
        nftables_active={{ ((nftables_active.rc == 0) and ((nftables_active.stdout | trim) == 'active')) | string }}
      remediation: "Enable and configure a host firewall (UFW, nftables, or firewalld) with an inbound deny-by-default policy and only necessary ports allowed"
